<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeNe 自律管理系统</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .card { margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .timer-display { font-size: 4rem; font-weight: bold; text-align: center; margin: 20px 0; }
        .nav-link { cursor: pointer; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body>
    <div id="app">
        <!-- 导航栏 -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
            <div class="container">
                <a class="navbar-brand" href="#">NeNe 自律管理</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto" v-if="isLoggedIn">
                        <li class="nav-item"><a class="nav-link" :class="{active: currentView === 'dashboard'}" @click="currentView = 'dashboard'">仪表盘</a></li>
                        <li class="nav-item"><a class="nav-link" :class="{active: currentView === 'tasks'}" @click="currentView = 'tasks'">任务管理</a></li>
                        <li class="nav-item"><a class="nav-link" :class="{active: currentView === 'pomodoro'}" @click="currentView = 'pomodoro'">番茄钟</a></li>
                    </ul>
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item" v-if="!isLoggedIn">
                            <a class="nav-link" @click="currentView = 'login'">登录</a>
                        </li>
                        <li class="nav-item" v-if="!isLoggedIn">
                            <a class="nav-link" @click="currentView = 'register'">注册</a>
                        </li>
                        <li class="nav-item" v-if="isLoggedIn">
                            <a class="nav-link" @click="logout">退出 ({{ username }})</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container">
            <!-- 登录视图 -->
            <div v-if="currentView === 'login'" class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">登录</div>
                        <div class="card-body">
                            <form @submit.prevent="login">
                                <div class="mb-3">
                                    <label class="form-label">用户名</label>
                                    <input type="text" class="form-control" v-model="loginForm.username" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">密码</label>
                                    <input type="password" class="form-control" v-model="loginForm.password" required>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">登录</button>
                            </form>
                            <p class="mt-3 text-center">
                                还没有账号? <a href="#" @click.prevent="currentView = 'register'">去注册</a>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 注册视图 -->
            <div v-if="currentView === 'register'" class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">注册</div>
                        <div class="card-body">
                            <form @submit.prevent="register">
                                <div class="mb-3">
                                    <label class="form-label">用户名</label>
                                    <input type="text" class="form-control" v-model="registerForm.username" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">密码</label>
                                    <input type="password" class="form-control" v-model="registerForm.password" required>
                                </div>
                                <button type="submit" class="btn btn-success w-100">注册</button>
                            </form>
                            <p class="mt-3 text-center">
                                已有账号? <a href="#" @click.prevent="currentView = 'login'">去登录</a>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 仪表盘视图 -->
            <div v-if="currentView === 'dashboard' && isLoggedIn">
                <div class="row">
                    <div class="col-md-4">
                        <div class="card text-white bg-success mb-3">
                            <div class="card-header">自律评分</div>
                            <div class="card-body">
                                <h1 class="card-title text-center">{{ stats.discipline_score }}</h1>
                                <p class="card-text text-center">分</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-white bg-info mb-3">
                            <div class="card-header">今日完成任务</div>
                            <div class="card-body">
                                <h1 class="card-title text-center">{{ stats.completed_tasks_count }}</h1>
                                <p class="card-text text-center">个</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-white bg-warning mb-3">
                            <div class="card-header">专注时长</div>
                            <div class="card-body">
                                <h1 class="card-title text-center">{{ stats.total_pomodoro_minutes }}</h1>
                                <p class="card-text text-center">分钟</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">行为雷达图</div>
                            <div class="card-body">
                                <canvas id="radarChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">今日待办</div>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between align-items-center" v-for="task in tasks" :key="task.id">
                                    <span :style="{ textDecoration: task.is_completed ? 'line-through' : 'none', color: task.is_completed ? 'gray' : 'inherit' }">
                                        {{ task.title }} 
                                        <small class="text-muted">({{ task.progress }}/{{ task.target_value }} {{ task.target_type === 'time' ? '分' : '次' }})</small>
                                    </span>
                                    <button class="btn btn-sm btn-outline-success" @click="checkInTask(task.id)" :disabled="task.is_completed" v-if="task.target_type !== 'time'">打卡</button>
                                </li>
                                <li class="list-group-item text-center text-muted" v-if="tasks.length === 0">暂无任务</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 任务管理视图 -->
            <div v-if="currentView === 'tasks' && isLoggedIn">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>我的任务</span>
                        <button class="btn btn-primary btn-sm" @click="showCreateTaskModal = true">新建任务</button>
                    </div>
                    <div class="card-body">
                        <div v-for="(groupTasks, date) in groupedTasks" :key="date" class="mb-4">
                            <h5 class="border-bottom pb-2">{{ date }}</h5>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>任务名称</th>
                                            <th>描述</th>
                                            <th>目标</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="task in groupTasks" :key="task.id">
                                            <td>{{ task.title }}</td>
                                            <td>{{ task.description }}</td>
                                            <td>{{ task.target_value }} {{ task.target_type === 'time' ? '分钟' : '次' }}</td>
                                            <td>
                                                <button class="btn btn-sm btn-danger" @click="deleteTask(task.id)">删除</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div v-if="tasks.length === 0" class="text-center text-muted">暂无任务</div>
                    </div>
                </div>

                <!-- 新建任务模态框 (简化版，直接内嵌) -->
                <div v-if="showCreateTaskModal" class="modal d-block" style="background: rgba(0,0,0,0.5)">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">新建任务</h5>
                                <button type="button" class="btn-close" @click="showCreateTaskModal = false"></button>
                            </div>
                            <div class="modal-body">
                                <form @submit.prevent="createTask">
                                    <div class="mb-3">
                                        <label class="form-label">任务名称</label>
                                        <input type="text" class="form-control" v-model="newTask.title" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">描述</label>
                                        <textarea class="form-control" v-model="newTask.description"></textarea>
                                    </div>
                                    <div class="row">
                                        <div class="col-6 mb-3">
                                            <label class="form-label">目标类型</label>
                                            <select class="form-select" v-model="newTask.target_type">
                                                <option value="count">次数</option>
                                                <option value="time">时长</option>
                                            </select>
                                        </div>
                                        <div class="col-6 mb-3">
                                            <label class="form-label">目标值</label>
                                            <input type="number" class="form-control" v-model="newTask.target_value" min="1">
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-end">
                                        <button type="button" class="btn btn-secondary me-2" @click="showCreateTaskModal = false">取消</button>
                                        <button type="submit" class="btn btn-primary">保存</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 番茄钟视图 -->
            <div v-if="currentView === 'pomodoro' && isLoggedIn">
                <div class="row justify-content-center">
                    <div class="col-md-6">
                        <div class="card text-center">
                            <div class="card-header">
                                番茄专注
                            </div>
                            <div class="card-body">
                                <h5 class="card-title">{{ pomodoroStatus === 'work' ? '专注中' : (pomodoroStatus === 'break' ? '休息中' : '准备开始') }}</h5>
                                
                                <div class="mb-3" v-if="pomodoroStatus === 'idle'">
                                    <select class="form-select mb-2" v-model="selectedTaskId">
                                        <option value="">-- 选择关联任务 (可选) --</option>
                                        <option v-for="task in tasks" :key="task.id" :value="task.id">{{ task.title }}</option>
                                    </select>
                                    
                                    <div class="input-group">
                                        <span class="input-group-text">专注时长(分钟)</span>
                                        <input type="number" class="form-control" v-model="customDuration" min="1" max="120">
                                    </div>
                                </div>

                                <div class="timer-display">{{ formatTime(pomodoroTime) }}</div>
                                <div class="btn-group">
                                    <button class="btn btn-lg btn-primary" v-if="!pomodoroActive" @click="startPomodoro">开始专注</button>
                                    <button class="btn btn-lg btn-warning" v-if="pomodoroActive" @click="pausePomodoro">暂停</button>
                                    <button class="btn btn-lg btn-danger" @click="resetPomodoro">重置</button>
                                </div>
                            </div>
                            <div class="card-footer text-muted">
                                每次专注 25 分钟，休息 5 分钟
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>
